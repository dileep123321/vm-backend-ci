name: Deploy App to GCP VM

on:
  push:
    branches: ["main"]
  workflow_dispatch:

env:
  PROJECT_ID: kxnwork
  ZONE: asia-southeast1-a
  VM_NAME: kxn-backend-vm-new01
  DEPLOY_USER: deployuser01

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          project_id: ${{ env.PROJECT_ID }}
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Load SSH Key from Secret Manager
        run: |
          gcloud secrets versions access latest \
            --secret="kxn-ssh-secret-new01" \
            --project="${{ env.PROJECT_ID }}" > ssh_key
          chmod 600 ssh_key

      - name: Load Environment Variables from Secret Manager
        run: |
          gcloud secrets versions access latest \
            --secret="kxn-env-secret-new01" \
            --project="${{ env.PROJECT_ID }}" > app.env

      - name: Get VM External IP
        id: vmip
        run: |
          IP=$(gcloud compute instances describe "${{ env.VM_NAME }}" \
            --zone="${{ env.ZONE }}" \
            --project="${{ env.PROJECT_ID }}" \
            --format="value(networkInterfaces[0].accessConfigs[0].natIP)")
          echo "VM_IP=$IP" >> $GITHUB_OUTPUT

      - name: Add VM to known_hosts
        run: ssh-keyscan -H ${{ steps.vmip.outputs.VM_IP }} >> ~/.ssh/known_hosts

      - name: Upload Backend Files to VM
        run: |
          scp -i ssh_key -o StrictHostKeyChecking=yes app.py requirements.txt app.env \
            "${{ env.DEPLOY_USER }}"@${{ steps.vmip.outputs.VM_IP }}:/home/${{ env.DEPLOY_USER }}/app/

      - name: Install Dependencies & Restart Service
        run: |
          ssh -i ssh_key -o StrictHostKeyChecking=yes "${{ env.DEPLOY_USER }}"@${{ steps.vmip.outputs.VM_IP }} << 'EOF'
            cd /home/deployuser01/app
            python3 -m venv venv
            source venv/bin/activate
            pip install --upgrade pip
            pip install -r requirements.txt
            sudo systemctl restart kxn-backend-new01.service
EOF

