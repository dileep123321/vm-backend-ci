name: Deploy Backend to VM

on:
  push:
    branches: ["main"]

permissions:
  contents: read

env:
  PROJECT_ID: kxnwork
  VM_NAME: kxn-backend-vm-new01
  ZONE: asia-southeast1-a
  DEPLOY_USER: deployuser01
  SECRET_SSH: kxn-ssh-secret-new01
  SECRET_ENV: kxn-env-secret-new01

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ env.PROJECT_ID }}
          service_account_key: ${{ secrets.GCP_SA_KEY }}

      - name: Load SSH key
        run: |
          gcloud secrets versions access latest --secret="$SECRET_SSH" --project="$PROJECT_ID" > ssh_key
          chmod 600 ssh_key

      - name: Load environment variables
        run: |
          gcloud secrets versions access latest --secret="$SECRET_ENV" --project="$PROJECT_ID" > app.env

      - name: Get VM external IP
        id: vmip
        run: |
          IP=$(gcloud compute instances describe "$VM_NAME" \
            --zone "$ZONE" \
            --project "$PROJECT_ID" \
            --format="value(networkInterfaces[0].accessConfigs[0].natIP)")
          echo "VM_IP=$IP" >> $GITHUB_OUTPUT

      - name: Add VM to known_hosts
        run: ssh-keyscan -H ${{ steps.vmip.outputs.VM_IP }} >> ~/.ssh/known_hosts

      - name: Upload backend files
        run: |
          scp -i ssh_key -o StrictHostKeyChecking=yes app.py requirements.txt app.env \
            "$DEPLOY_USER"@${{ steps.vmip.outputs.VM_IP }}:/home/$DEPLOY_USER/app/

      - name: Install dependencies and restart service
        run: |
          ssh -i ssh_key -o StrictHostKeyChecking=yes "$DEPLOY_USER"@${{ steps.vmip.outputs.VM_IP }} << 'EOF'
cd /home/deployuser01/app
python3 -m venv venv
source venv/bin/activate
pip install --upgrade pip
pip install -r requirements.txt
sudo systemctl restart kxn-backend-new01.service
EOF
